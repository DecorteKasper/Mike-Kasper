<template>
  <Container class="py-12">
    <header class="flex items-center justify-between">
      <RouterLink
        class="flex items-center space-x-4 hover:opacity-30 focus:outline-none focus-visible:ring-4 ring-blue-400 rounded-lg"
        to="/">
        <svg id="logo" class="max-w-52" xmlns=" http://www.w3.org/2000/svg" width="533.58" viewBox="0 0 533.58 120.489">
          <text id="F" transform="translate(0 97.489)" font-size="90" font-family="SegoeUI-Bold, Segoe UI"
            font-weight="700">
            <tspan x="0" y="0">F</tspan>
          </text>
          <text id="R" transform="translate(118.502 97.13)" font-size="90" font-family="SegoeUI-Bold, Segoe UI"
            font-weight="700">
            <tspan x="0" y="0">R</tspan>
          </text>
          <text id="GUARDS" transform="translate(168.58 97)" fill="#ed6a5a" font-size="90"
            font-family="SegoeUI-Bold, Segoe UI" font-weight="700">
            <tspan x="0" y="0">G</tspan>
            <tspan y="0" letter-spacing="-0.012em">U</tspan>
            <tspan y="0">ARDS</tspan>
          </text>
          <path id="Path_24" data-name="Path 24"
            d="M95.188,22.8a30.95,30.95,0,1,0,0,43.77,30.95,30.95,0,0,0,0-43.77ZM63.156,54.831a14.35,14.35,0,1,1,20.294,0A14.35,14.35,0,0,1,63.156,54.831Z"
            transform="translate(10 19.96)" fill="#e6e6e6" />
          <path id="Path_25" data-name="Path 25"
            d="M59.9,66.57A30.95,30.95,0,0,1,77.544,14.026a30.95,30.95,0,1,0,0,61.317A30.812,30.812,0,0,1,59.9,66.57Z"
            transform="translate(10 19.96)" fill="#ccc" />
          <path id="Path_26" data-name="Path 26"
            d="M95.188,22.8A30.871,30.871,0,0,0,71.8,13.771a30.95,30.95,0,0,1,0,61.828A30.95,30.95,0,0,0,95.188,22.8Z"
            transform="translate(10 19.96)" fill="#fff" />
          <path id="Path_27" data-name="Path 27"
            d="M98.535,26.584l-8.859,8.859v0l-2.632,2.63a2.4,2.4,0,0,1-3.4,0l-3.732-3.732a2.4,2.4,0,0,1,0-3.4l6.169-6.169L91.4,19.452a2.4,2.4,0,0,1,3.4,0l3.732,3.732A2.4,2.4,0,0,1,98.535,26.584Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_28" data-name="Path 28"
            d="M94.8,69.917l3.733-3.733a2.4,2.4,0,0,0,0-3.4L87.045,51.294a2.4,2.4,0,0,0-3.4,0l-3.733,3.733a2.4,2.4,0,0,0,0,3.4L91.4,69.917A2.4,2.4,0,0,0,94.8,69.917Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_29" data-name="Path 29"
            d="M89.676,35.443v0l-2.632,2.63a2.4,2.4,0,0,1-3.4,0l-3.732-3.732a2.4,2.4,0,0,1,0-3.4l6.169-6.169a13.143,13.143,0,0,0,3.594,10.669Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_30" data-name="Path 30"
            d="M89.676,53.926v0l-2.632-2.63a2.4,2.4,0,0,0-3.4,0l-3.732,3.732a2.4,2.4,0,0,0,0,3.4L86.082,64.6a13.143,13.143,0,0,1,3.594-10.669Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_31" data-name="Path 31"
            d="M66.693,58.428l-6.04,6.04L55.2,69.918a2.4,2.4,0,0,1-3.4,0l-3.734-3.734a2.4,2.4,0,0,1,0-3.4L59.56,51.294a2.4,2.4,0,0,1,3.4,0l3.734,3.732a2.408,2.408,0,0,1,0,3.4Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_32" data-name="Path 32"
            d="M66.693,34.342l-3.734,3.732a2.4,2.4,0,0,1-3.4,0l-4.134-4.134-7.357-7.357a2.4,2.4,0,0,1,0-3.4L51.8,19.452a2.4,2.4,0,0,1,3.4,0L60.653,24.9l6.04,6.04a2.4,2.4,0,0,1,0,3.4Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_33" data-name="Path 33"
            d="M48.069,26.584a2.4,2.4,0,0,1,0-3.4L51.8,19.452a2.4,2.4,0,0,1,3.4,0L60.654,24.9a30.71,30.71,0,0,0-5.228,9.038l-7.356-7.357Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_34" data-name="Path 34"
            d="M55.426,55.428a30.7,30.7,0,0,0,5.228,9.039L55.2,69.918a2.4,2.4,0,0,1-3.4,0l-3.734-3.734a2.4,2.4,0,0,1,0-3.4l7.356-7.356Z"
            transform="translate(10 19.96)" fill="#ed6a5a" />
          <path id="Path_35" data-name="Path 35"
            d="M106.595,33.744a17.938,17.938,0,0,0-5.6-5.65q-.429-.714-.9-1.41a3.736,3.736,0,0,0-.627-4.439l-3.733-3.733a3.73,3.73,0,0,0-4.441-.628,32.03,32.03,0,0,0-8.222-3.969,1.327,1.327,0,0,0-.8,2.531,29.378,29.378,0,0,1,6.982,3.273L78.974,30c-.015.015-.027.031-.042.046a15.614,15.614,0,0,0-11.258,0c-.015-.015-.027-.032-.042-.047L57.346,19.719A29.489,29.489,0,0,1,77.363,15.34a1.327,1.327,0,1,0,.362-2.63A32.133,32.133,0,0,0,55.3,17.885a3.73,3.73,0,0,0-4.44.628l-3.733,3.733a3.73,3.73,0,0,0-.629,4.44q-.425.63-.818,1.275l-.037-.076a16.87,16.87,0,0,0-5.977,5.859c-4.564,6.968-5.056,15.929-4.666,22.219a7.926,7.926,0,0,0,2.9,5.9A11.205,11.205,0,0,0,44.936,64c.376,0,.759-.016,1.146-.043a3.724,3.724,0,0,0,1.05,3.164l3.733,3.733a3.729,3.729,0,0,0,4.441.628l.133.09A18.488,18.488,0,0,0,73.3,83.4,18.488,18.488,0,0,0,91.168,71.574l.133-.09a3.729,3.729,0,0,0,4.441-.628l3.733-3.733a3.724,3.724,0,0,0,1.053-3.142c.27.013.538.022.8.022a11.206,11.206,0,0,0,7.027-2.143,7.926,7.926,0,0,0,2.9-5.9c.391-6.29-.1-15.25-4.665-22.219ZM80.851,31.881,92.342,20.39a1.077,1.077,0,0,1,1.523,0L97.6,24.123a1.078,1.078,0,0,1,0,1.523L86.106,37.136a1.077,1.077,0,0,1-1.523,0L80.851,33.4a1.077,1.077,0,0,1,0-1.523Zm-2.963.616c0,.049-.007.1-.007.146a3.706,3.706,0,0,0,1.093,2.639l3.733,3.733a3.707,3.707,0,0,0,2.638,1.093c.049,0,.1-.005.146-.007a12.964,12.964,0,0,1,0,9.17c-.048,0-.1-.007-.144-.007a3.706,3.706,0,0,0-2.638,1.093l-3.733,3.733a3.707,3.707,0,0,0-1.093,2.639c0,.049.005.1.007.144a12.963,12.963,0,0,1-9.172,0,3.718,3.718,0,0,0-1.084-2.784L63.9,50.356a3.707,3.707,0,0,0-2.639-1.093c-.049,0-.1.005-.145.007a12.962,12.962,0,0,1,0-9.17c.048,0,.1.007.145.007A3.706,3.706,0,0,0,63.9,39.014l3.733-3.733A3.718,3.718,0,0,0,68.715,32.5,12.96,12.96,0,0,1,77.888,32.5ZM48.337,60.64a29.663,29.663,0,0,1,0-31.912L58.622,39.013c.015.015.032.028.047.042a15.612,15.612,0,0,0,0,11.257c-.015.015-.032.027-.046.042L48.337,60.64Zm.671-36.517,3.733-3.733a1.077,1.077,0,0,1,1.523,0L65.755,31.88a1.078,1.078,0,0,1,0,1.523l-3.733,3.733a1.077,1.077,0,0,1-1.523,0L49.008,25.646a1.077,1.077,0,0,1,0-1.523ZM39.565,59.786A5.277,5.277,0,0,1,37.654,55.8c-.362-5.821.062-14.09,4.129-20.434.372-.58.748-1.1,1.118-1.569a32.407,32.407,0,0,0,2.736,27.53,9.119,9.119,0,0,1-6.072-1.541ZM53.5,69.294a1.071,1.071,0,0,1-.762-.315l-3.733-3.733a1.078,1.078,0,0,1,0-1.523L60.5,52.232a1.077,1.077,0,0,1,1.523,0l3.733,3.733a1.078,1.078,0,0,1,0,1.523L63.7,59.546a1.327,1.327,0,1,0,1.877,1.877l2.059-2.058c.015-.015.027-.031.042-.046a15.594,15.594,0,0,0,11.257,0c.015.015.028.032.043.048L89.259,69.65a29.661,29.661,0,0,1-31.912,0l5.483-5.483a1.327,1.327,0,0,0-1.877-1.877l-6.689,6.689a1.07,1.07,0,0,1-.761.315Zm19.8,11.45c-7.252,0-11.356-3.622-13.547-6.749A32.414,32.414,0,0,0,86.85,74C84.659,77.123,80.556,80.744,73.3,80.744ZM97.6,65.246l-3.733,3.733h0a1.076,1.076,0,0,1-1.523,0L80.85,57.488a1.076,1.076,0,0,1,0-1.523l3.733-3.733a1.077,1.077,0,0,1,1.523,0L97.6,63.723a1.078,1.078,0,0,1,0,1.523ZM108.611,55.8a5.277,5.277,0,0,1-1.911,3.987,8.916,8.916,0,0,1-5.739,1.552,32.019,32.019,0,0,0,3.216-7.216,1.327,1.327,0,1,0-2.539-.774,29.366,29.366,0,0,1-3.369,7.292L87.984,50.355c-.015-.015-.032-.028-.047-.043a15.614,15.614,0,0,0,0-11.257c.015-.014.031-.027.046-.042L98.268,28.728A29.468,29.468,0,0,1,102.613,49a1.327,1.327,0,1,0,2.627.384A32.262,32.262,0,0,0,104,34.642q.244.346.487.723c4.068,6.343,4.491,14.613,4.129,20.434Z"
            transform="translate(10 19.96)" />
        </svg>
      </RouterLink>
      <nav>
        <ul class="lg:flex items-center space-x-12 hidden">

           <!-- HOME PAGINA HOOFDREDDER -->
          <li v-if="userData?.role === 300">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/">Home</RouterLink>
          </li>

          <!-- HOME PAGINA REDDER -->
          <li v-if="userData?.role === 200">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/redder">Home</RouterLink>
          </li>

          <!-- PLANNING PAGINA HOOFDREDDER -->
          <li v-if="userData?.role === 300">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/schedule">Planning</RouterLink>
          </li>
          
          <!-- PLANNING PAGINA REDDER + CHECKS -->
          <li v-if="userData?.role === 200 && checkMonths && !checkHolidays">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/redder/months">Keuze maanden</RouterLink>
          </li>
          <li v-if="userData?.role === 200 && checkHolidays && !checkMonths">
              <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
                active-class="text-dark_green font-semibold" to="/redder/chooseschedule">Keuze verlofdagen</RouterLink>
          </li>
          <li v-if="userData?.role === 200 && checkHolidays && checkMonths">
                <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
                  active-class="text-dark_green font-semibold" to="/redder/schedule">Planning</RouterLink>
          </li>


          
          <li v-if="userData?.role === 300">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/reports">Verslagen</RouterLink>
          </li>
          
          <li v-if="userData?.role === 200">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/redder/report">Dagverslag</RouterLink>
          </li>

          <li v-if="userData?.role === 100">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/reports">Test ehbo</RouterLink>
          </li>

          <li>
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/sos">SOS</RouterLink>
          </li>
          <li v-if="userData?.role === 300">
            <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
              active-class="text-dark_green font-semibold" to="/jobs">Jobs</RouterLink>
          </li>
          <!-- Menu 1 -->
          <li class="relative">
            <button @click="toggleSubmenu">
              <div class="flex items-center py-2 space-x-4 px-4 rounded-inputFieldRadius hover:bg-dark_grey"
                :class="{ 'bg-dark_grey': isSubmenuOpen, 'bg-gray': !isSubmenuOpen }">
                <img v-if="hasUserPhoto" class="rounded-full h-12" :src="GetUserPhoto" alt="Profile Picture">
                <div v-else>
                  <UserCircle2 class="h-7 w-7 object-cover text-dark_green" />
                </div>
                <p class="font-lato text-sm">Dag, {{ userData?.name }}</p>
              </div>
            </button>
            <!-- Submenu -->
            <div
              class="bg-dark_grey top-18 p-6 rounded-inputFieldRadius w-full absolute transition-all delay-50 origin-top ease-in-out"
              :class="{ 'scale-y-0': !isSubmenuOpen, 'scale-y-100': isSubmenuOpen }">
              <ul class=" flex flex-col gap-2">
                <li>
                  <RouterLink class="text-black font-lato text-xs hover:text-dark_green"
                    active-class="text-dark_green font-semibold" to="/account">Account</RouterLink>
                </li>
                <li>
                  <button @click="logoutUser"
                    class="px-2 py-2 text-white text-xs bg-red rounded-md focus:outline-none focus-visible:ring-4 ring-red-300 hover:bg-red-800">
                    Log out
                  </button>
                </li>
              </ul>
            </div>
          </li>
        </ul>
      </nav>
      <button class="lg:hidden flex" @click="isMenuOpen = true">
        <MenuIcon :size="32" />
      </button>
    </header>
    <!-- Hamburger menu -->
    <div
      class="fixed inset-0 flex justify-center items-center backdrop-blur-md bg-green/60 transform transition-transform duration-500"
      :class="{ 'translate-x-0': isMenuOpen, '-translate-x-full': !isMenuOpen }" @click="closeMenu">
      <button @click="isMenuOpen = false">
        <XIcon class="absolute top-13 right-8 text-black" :size="32" />
      </button>
      <ul class="flex flex-col gap-4">
        <li @click="isMenuOpen = false" v-if="userData?.role === 300">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/">Home</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 200">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/redder">Home</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 300">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/schedule">Planning</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 200">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/redder/schedule">Planning</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 100">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/reports">Test ehbo</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 300">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/reports">Verslagen</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 200">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/redder/report">Dagverslag</RouterLink>
        </li>

        <li @click="isMenuOpen = false" v-if="userData?.role === 100">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/reports">Test ehbo</RouterLink>
        </li>
        <li @click="isMenuOpen = false">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/sos">SOS</RouterLink>
        </li>
        <li @click="isMenuOpen = false" v-if="userData?.role === 300">
          <RouterLink class="text-black font-lato text-base font-semibold hover:text-dark_green"
            active-class="text-dark_green font-semibold" to="/jobs">Jobs</RouterLink>
        </li>
      </ul>
    </div>

  </Container>
</template>


<script lang="ts">

import useFirebase from '@/composables/useFirebase'
import Container from './Container.vue'
import { GET_USER_BY_UID } from '@/graphql/user.query'
import { useQuery } from '@vue/apollo-composable'
import { ref, watch } from 'vue'
import { MenuIcon, XIcon } from 'lucide-vue-next';

import { UserCircle2 } from 'lucide-vue-next'
import { useRouter } from 'vue-router'

//Checks
import { ALL_CHECKS } from '@/graphql/check.query'
import type { Icheck } from '@/interfaces/check.interface'


interface User {
  id: string
  uid: string
  name: string
  surname: string
  photoURL: string | null
  email: string
  phoneNumber: string
  zipCode: number
  street: string
  role: number
}

export default {
  components: { Container, MenuIcon, XIcon, UserCircle2 },

  mounted() {
    // Voeg een event listener toe om buiten het submenu te klikken
    document.addEventListener("click", this.handleClickOutsideSubmenu);
  },
  beforeUnmount() {
    // Verwijder het event listener wanneer het component wordt ontmanteld
    document.removeEventListener("click", this.handleClickOutsideSubmenu);
  },

  methods: {
    toggleMenu() {
      this.isMenuOpen = !this.isMenuOpen;
    },
    toggleSubmenu() {
      this.isSubmenuOpen = !this.isSubmenuOpen;
    },
    closeMenu() {
      this.isMenuOpen = false;
    },
    handleClickOutsideSubmenu(event: MouseEvent) {
      const submenu = this.$el.querySelector(".bg-dark_grey");

      if (submenu && !submenu.contains(event.target)) {
        this.isSubmenuOpen = false;
      }
    }
  },

  computed: {
    hasUserPhoto() {
      return this.userData && this.userData.photoURL;
    },
    GetUserPhoto() {
      if (this.userData && this.userData.photoURL) {
        return this.userData.photoURL;
      }
    }
  },

  setup() {
    const { firebaseUser } = useFirebase()
    const userData = ref<User | null>()
    const isMenuOpen = ref(false)
    const isSubmenuOpen = ref(false)
    const { logout } = useFirebase()
    const { replace } = useRouter()
    const accessPlatform = ref();
    const checkHolidays = ref();
    const checkMonths = ref();


    const logoutUser = () => {
      logout().then(() => {
        replace({ path: '/auth/login' })
      })
    }

    const { loading: userLoading, result: user, error: userError } = useQuery(GET_USER_BY_UID, {uid: firebaseUser.value?.uid,})
    //Checks from db
    const { loading: checkLoading, result: checkResult, error: checkError } = useQuery<{ checks: Icheck[] }> (ALL_CHECKS);

    // Watch the user result and set userRole when it's available
    watch(user, (newValue) => {
      if (newValue && newValue.userByUid) {
        userData.value = newValue.userByUid
      }
    })

    watch(checkResult, (newValue) => {
      if (newValue && newValue.checks && newValue.checks.length > 0) {
        const checkValues = newValue.checks[0]; // Assuming you want properties from the first element
        accessPlatform.value = checkValues.accessPlatform;
        checkHolidays.value = checkValues.checkHolidays;
        checkMonths.value = checkValues.checkMonths;
        console.log("accessPlatform", accessPlatform.value)
        console.log("checkHolidays", checkHolidays.value)
        console.log("checkMonths", checkMonths.value)
      }
    });


    return {
      userLoading,
      userError,
      userData,
      isMenuOpen,
      isSubmenuOpen,
      logoutUser,
      accessPlatform,
      checkHolidays,
      checkMonths,
    }
  },
}
</script>



